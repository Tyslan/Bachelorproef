\chapter{Back-ups in Cassandra}
\label{ch:cassandra_backups}

\section{Snapshots}
Om back-ups te maken voorziet Cassandra snapshots.
Een snapshot is een verzameling van pointers die naar de data in de database verwijzen.
Men kan zowel van alle keyspaces, één enkele keyspace of één enkele tabel een snapshot nemen, zolang Cassandra nodes heeft die online zijn.
Ook van een ganse cluster kan een snapshot genomen worden, maar hier kan het wel voorkomen dat de data in verschillende nodes niet consistent is.
De snapshots worden telkens in een nieuwe file opgeslagen, maar kunnen ook incrementeel groeien \citep{DataStax2016Snapshot}.

Snapshots worden via nodetool genomen.
De enige voorwaarde die opgelegd wordt bij het maken van snapshots is dat er voldoende plaats aanwezig is op de node waar de snapshot geplaatst zal worden.
Het command om een snapshot te nemen ziet er als volgt uit:

\begin{lstlisting}[language=Bash, breaklines=true]
$ nodetool -h host -p JMXport snapshot mykeyspace
\end{lstlisting}

Het gebruik van snapshots heeft wel een nadeel.
Het verhindert de verwijdering van oude, overbodige records \citep{DataStax2016Snapshot}.
Snapshots verhinderen dus dat data die gemarkeerd is met een ''tombstone marker'' verwijderd wordt.
Deze markering werd reeds in het vorige hoofdstuk (\ref{sec:read_repair}) vermeld bij de herstelmechanismes.

Om een snapshot te gebruiken bij de herstelling van een database, moet men er eerst voor zorgen dat de tabellen die hersteld moeten worden, aangemaakt en ook leeg zijn.
Daarna kan men de snapshot inladen met de sstableloader tool.
Hierna sluit men de node die hersteld moet worden af en voert men vervolgens het commando ''nodetool drain'' uit.
Vervolgens moet de commitlog map leeggemaakt worden.
Een andere map die leeggemaakt moet worden, met uitzondering van de submappen snapshots en backups, is de data-map van de keyspace.
Hierna zoekt men de meest recente snapshot en plaatst deze in de keyspace map.
Wanneer er incrementele back-ups genomen zijn, moet men deze ook in deze map plaatsen.
Als laatste stap start men de node opnieuw op en voert men het commando ''nodetool repair'' uit.
Op deze manier is de node hersteld aan de hand van een snapshot \citep{DataStax2016Snapshot}.

\section{Nood aan back-ups in Cassandra}
Door met replica's te werken en de manier waarop dit gebeurt in Cassandra, zou men zich kunnen afvragen of het wel nodig is om back-ups te nemen.
Vóór deze vraag beantwoord kan worden, moet het verschil tussen replica's en snapshots eerst duidelijk uitgelegd worden.

Een snapshot neemt als het ware een foto van de databank op een bepaald tijdstip, vandaar ook de term snapshot.
In deze snapshot worden de referenties naar de data bijgehouden.
Verder wordt er ook voor gezorgd dat de verwijderde records niet echt verwijderd worden (\ref{sec:read_repair}).
Op deze manier wordt gegarandeerd dat de snapshots volledig blijven.
Door deze manier van werken, zijn de snapshots binnen Cassandra dan ook een volwaardige back-up.

Bij replica's wordt vaak foutief aangenomen dat deze een synoniem zijn voor back-ups.
Zoals eerder uitgelegd (\ref{sec_replication}) werd, worden replica's op een andere node opgeslagen om de beschikbaarheid van de data te garanderen.
Hierbij wordt de historische data, zoals aanpassingen aan de data, niet gekopieerd naar de andere nodes.
Dit is al een eerste aanwijzing waarom dit niet als een volwaardige back-up beschouw mag worden.
Een andere, belangrijkere reden is dat door de manier waarop gerepliceerd wordt binnen Cassandra, de replica's binnen enkele seconden de nieuwe waarden bevatten.
Indien hier een wijziging of verwijdering gebeurt, wordt dit onmiddellijk doorgegeven aan de andere nodes.
Wanneer deze handeling foutief uitgevoerd werd, kan men met replica's de originele data niet meer terugzetten.

Nu de verschillen tussen snapshots en replica's duidelijk zijn, is het ook veilig om te stellen dat er binnen Cassandra nog altijd back-ups nodig zijn.
Hierbij gaat het dan vooral om verlies van data, die foutief gewijzigd of verwijderd wordt, tegen te gaan.
Deze kunnen niet meer hersteld worden door middel van replica's.